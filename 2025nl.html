<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parliament Simulator</title><meta property="og:title" content="Parliament Simulator">
    <meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c0/Dutch_House_of_Representatives%2C_December_2023%2C_English_Wiki_colours.svg/1920px-Dutch_House_of_Representatives%2C_December_2023%2C_English_Wiki_colours.svg.png">
    <meta property="og:type" content="website"><meta property="og:url" content="https://flolhub.github.io/2025nl">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            max-width: 670px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .parliament {
            position: relative;
            width: 100%;
            margin: 30px 0;
            padding: 5px;
            box-sizing: border-box;
            overflow: hidden;
        }
        .seat {
            position: absolute;
            cursor: pointer;
            border-radius: 50%;
            box-sizing: border-box;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        .party-info {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .party-card {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            min-width: 134px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            background-color: white;
        }
        .party-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .party-card.selected {
            box-shadow: 0 0 0 3px var(--party-color);
            transform: translateY(-3px);
        }
        .party-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .party-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }
        .party-card-name { 
            font-weight: 600; 
        }
        .party-card-seats { 
            text-align: center; 
            font-size: 1.5rem; 
            font-weight: 700; 
        }
        button {
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            display: block;
            margin: 10px;
        }
        button:hover {
            transform: translateY(-2px);
        }
        .summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f8f8;
            border-radius: 5px;
        }
        .majority {
            background-color: #e8f5e9;
            border-left: 5px solid #4CAF50;
        }
        .no-majority {
            background-color: #ffebee;
            border-left: 5px solid #f44336;
        }
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 1.5rem;
        }
        #generateBtn { 
            background-color: #007bff; 
            color: white; 
        }
        #generateBtn:hover { 
            background-color: #0056b3; 
        }
        #adjustBtn {
            background-color: #6c757d; 
            color: white; 
        }
        #adjustBtn:hover { 
            background-color: #5a6268; 
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 5px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .margin-controls {
            margin: 15px 0;
        }
        .margin-control {
            margin: 10px 0;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            position: relative;
        }
        input[type="number"] {
            width: 60px;
            padding: 5px;
            margin: 0 5px;
        }
        .total-seats-control {
            margin: 20px 0;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 4px;
            font-weight: bold;
        }
        .add-party-control {
            margin: 20px 0;
            padding: 15px;
            background-color: #e8f5e9;
            border-radius: 4px;
        }
        .remove-party-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            cursor: pointer;
        }
        .add-party-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            margin-left: 10px;
        }
        .color-picker {
            width: 30px;
            height: 30px;
            padding: 0;
            border: 1px solid #ddd;
            vertical-align: middle;
            margin-right: 10px;
        }
        .party-name-input {
            padding: 5px;
            width: 150px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <h1>Parliament Simulator (<span id="totalSeatsDisplay">150</span> Seats)</h1>
    <div class="controls">
        <button id="generateBtn">Generate New Parliament</button>
        <button id="adjustBtn">Adjust Party Margins</button>
    </div>
    <div class="summary" id="summary">
        Click "Generate New Parliament" to start
    </div>
    <div class="parliament" id="parliament"></div>
    <div class="party-info" id="partyInfo"></div>

    <!-- Margin Adjustment Modal -->
    <div id="marginModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Adjust Party Margins</h2>
            <div class="total-seats-control">
                Total Seats: <input type="number" id="totalSeatsInput" value="150" min="1" max="1000">
            </div>
            <div id="marginControls" class="margin-controls"></div>
            <div class="add-party-control">
                <input type="text" id="newPartyName" class="party-name-input" placeholder="Party Name">
                <input type="color" id="newPartyColor" class="color-picker" value="#FF0000">
                <button id="addPartyBtn" class="add-party-btn">Add New Party</button>
            </div>
            <button id="saveMarginsBtn">Save Margins</button>
        </div>
    </div>

    <script>
        // Party configuration
        let parties = [
            {
                "name": "PvdD",
                "color": "#006B2D",
                "minSeats": 2,
                "defaultSeats": 4,
                "maxSeats": 7,
                "ideologyScore": -9
            },
            {
                "name": "SP",
                "color": "#F60000",
                "minSeats": 3,
                "defaultSeats": 5,
                "maxSeats": 9,
                "ideologyScore": -8
            },
            {
                "name": "DENK",
                "color": "#00B7B2",
                "minSeats": 2,
                "defaultSeats": 3,
                "maxSeats": 4,
                "ideologyScore": -6
            },
            {
                "name": "GL/PvdA",
                "color": "#DF111A",
                "minSeats": 17,
                "defaultSeats": 24,
                "maxSeats": 30,
                "ideologyScore": -5
            },
            {
                "name": "Volt",
                "color": "#582C83",
                "minSeats": 2,
                "defaultSeats": 3,
                "maxSeats": 5,
                "ideologyScore": -2
            },
            {
                "name": "D66",
                "color": "#00AE41",
                "minSeats": 7,
                "defaultSeats": 13,
                "maxSeats": 23,
                "ideologyScore": -1
            },
            {
                "name": "50PLUS",
                "color": "#92107D",
                "minSeats": 0,
                "defaultSeats": 1,
                "maxSeats": 2,
                "ideologyScore": 1
            },
            {
                "name": "NSC",
                "color": "#F0C400",
                "minSeats": 0,
                "defaultSeats": 0,
                "maxSeats": 1,
                "ideologyScore": 2
            },
            {
                "name": "CU",
                "color": "#00A7EB",
                "minSeats": 2,
                "defaultSeats": 3,
                "maxSeats": 6,
                "ideologyScore": 3
            },
            {
                "name": "CDA",
                "color": "#2CC84D",
                "minSeats": 18,
                "defaultSeats": 24,
                "maxSeats": 32,
                "ideologyScore": 3.5
            },
            {
                "name": "VVD",
                "color": "#0A2CCA",
                "minSeats": 10,
                "defaultSeats": 14,
                "maxSeats": 22,
                "ideologyScore": 6
            },
            {
                "name": "BBB",
                "color": "#94C11F",
                "minSeats": 2,
                "defaultSeats": 4,
                "maxSeats": 9,
                "ideologyScore": 7
            },
            {
                "name": "SGP",
                "color": "#EA5B0B",
                "minSeats": 2,
                "defaultSeats": 3,
                "maxSeats": 4,
                "ideologyScore": 8
            },
            {
                "name": "JA21",
                "color": "#242B57",
                "minSeats": 7,
                "defaultSeats": 13,
                "maxSeats": 19,
                "ideologyScore": 8
            },
            {
                "name": "PVV",
                "color": "#012758",
                "minSeats": 19,
                "defaultSeats": 32,
                "maxSeats": 36,
                "ideologyScore": 9
            },
            {
                "name": "FvD",
                "color": "#841818",
                "minSeats": 3,
                "defaultSeats": 4,
                "maxSeats": 5,
                "ideologyScore": 10
            }
        ];

        let currentSeatCounts = [];
        let selectedParties = new Set();
        let totalSeats = 150;

        // DOM elements
        const generateBtn = document.getElementById('generateBtn');
        const adjustBtn = document.getElementById('adjustBtn');
        const modal = document.getElementById('marginModal');
        const closeBtn = document.querySelector('.close');
        const saveMarginsBtn = document.getElementById('saveMarginsBtn');
        const marginControls = document.getElementById('marginControls');
        const totalSeatsInput = document.getElementById('totalSeatsInput');
        const totalSeatsDisplay = document.getElementById('totalSeatsDisplay');
        const addPartyBtn = document.getElementById('addPartyBtn');
        const newPartyName = document.getElementById('newPartyName');
        const newPartyColor = document.getElementById('newPartyColor');

        // Event listeners
        generateBtn.addEventListener('click', generateParliament);
        adjustBtn.addEventListener('click', showMarginModal);
        closeBtn.addEventListener('click', closeModal);
        saveMarginsBtn.addEventListener('click', saveMargins);
        addPartyBtn.addEventListener('click', addNewParty);
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal();
            }
        });

        function generateParliament() {
            // Reset selections
            selectedParties = new Set();
            
            // First pass - generate initial seat counts weighted toward defaults
            currentSeatCounts = [];
            let currentTotalSeats = 0;
            
            // Generate initial seat counts within min/max, weighted toward default
            parties.forEach(party => {
                // Create a distribution that favors values near the default
                const range = party.maxSeats - party.minSeats;
                let seats;
                
                // Try to get values near the default (normal distribution)
                do {
                    // Standard deviation is 1/4 of the range to keep it somewhat centered
                    const stdDev = range / 4;
                    seats = Math.round(randomNormal(party.defaultSeats, stdDev));
                    seats = Math.max(party.minSeats, Math.min(party.maxSeats, seats));
                } while (isNaN(seats));
                
                currentSeatCounts.push({
                    party: party,
                    seats: seats
                });
                currentTotalSeats += seats;
            });

            // Adjust to exactly totalSeats seats
            while (currentTotalSeats !== totalSeats) {
                const difference = totalSeats - currentTotalSeats;
                const adjustment = Math.sign(difference);

                // Find parties that can be adjusted without violating their constraints
                const adjustableParties = currentSeatCounts.filter(sc => {
                    if (adjustment > 0) return sc.seats < sc.party.maxSeats;
                    else return sc.seats > sc.party.minSeats;
                });

                if (adjustableParties.length === 0) break;

                // Distribute the adjustment randomly among adjustable parties
                const randomParty = adjustableParties[Math.floor(Math.random() * adjustableParties.length)];
                randomParty.seats += adjustment;
                currentTotalSeats += adjustment;
            }

            // Render parliament visualization
            renderParliament();

            // Update summary
            updateSummary();
        }

        function renderParliament() {
            const parliamentEl = document.getElementById('parliament');
            const partyInfoEl = document.getElementById('partyInfo');
            parliamentEl.innerHTML = '';
            partyInfoEl.innerHTML = '';
            const totalGeneratedSeats = currentSeatCounts.reduce((sum, sc) => sum + sc.seats, 0);
            if (totalGeneratedSeats === 0) return;

            // Dynamically set min-height to maintain aspect ratio
            const containerWidth = parliamentEl.offsetWidth;
            parliamentEl.style.minHeight = `${containerWidth / 2}px`;
            
            const containerHeight = parliamentEl.offsetHeight;
            const centerX = containerWidth / 2;
            const centerY = containerHeight;
            const numRows = 6;
            const seatSize = Math.max(8, Math.min(20, (containerWidth * 0.8) / (totalGeneratedSeats / numRows)));
            
            // Ensure the diagram fits within the container on all screen sizes
            const maxRadius = Math.min(containerWidth / 2, containerHeight);
            const outerRadius = maxRadius - seatSize; // Leave padding
            const innerRadius = outerRadius * 0.5; // Maintain a proportional inner radius
            const radiusStep = (numRows > 1) ? (outerRadius - innerRadius) / (numRows - 1) : 0;
            
            let seatsInRows = calculateSeatsPerRow(totalGeneratedSeats, numRows, innerRadius, outerRadius);
            
            // Create a version sorted by ideology for the diagram
            const seatsSortedByIdeology = [...currentSeatCounts].sort((a, b) => a.party.ideologyScore - b.party.ideologyScore);
            const allSeats = [];
            seatsSortedByIdeology.forEach(sc => {
                for (let i = 0; i < sc.seats; i++) { allSeats.push(sc.party); }
            });

            const seatPositions = [];
            for (let row = 0; row < numRows; row++) {
                const seatsInThisRow = seatsInRows[row];
                const radius = outerRadius - (row * radiusStep);
                for (let i = 0; i < seatsInThisRow; i++) {
                    const angle = Math.PI - ((i + 0.5) / seatsInThisRow) * Math.PI;
                    const x = centerX + radius * Math.cos(angle) - (seatSize / 2);
                    const y = centerY - radius * Math.sin(angle) - (seatSize / 2);
                    seatPositions.push({ x, y, angle });
                }
            }

            seatPositions.sort((a, b) => b.angle - a.angle);

            allSeats.forEach((party, index) => {
                if (index >= seatPositions.length) return;
                const position = seatPositions[index];
                const seat = document.createElement('div');
                seat.className = 'seat';
                seat.style.backgroundColor = party.color;
                seat.title = party.name;
                seat.dataset.party = party.name;
                seat.style.width = `${seatSize}px`;
                seat.style.height = `${seatSize}px`;
                seat.style.left = `${position.x}px`;
                seat.style.top = `${position.y}px`;
                seat.addEventListener('click', () => togglePartySelection(party.name));
                parliamentEl.appendChild(seat);
            });

            // Create a version sorted by seat count for the cards
            const cardsSortedBySeats = [...currentSeatCounts].sort((a, b) => b.seats - a.seats);
            cardsSortedBySeats.forEach(sc => {
                if (sc.seats <= 0) return;
                const card = document.createElement('div');
                card.className = `party-card ${selectedParties.has(sc.party.name) ? 'selected' : ''}`;
                card.style.setProperty('--party-color', sc.party.color);
                card.innerHTML = `<div class="party-card-header"><span class="party-color" style="background-color: ${sc.party.color}"></span><strong class="party-card-name">${sc.party.name}</strong></div><div class="party-card-seats">${sc.seats}</div>`;
                card.addEventListener('click', () => togglePartySelection(sc.party.name));
                partyInfoEl.appendChild(card);
            });
        }

        function calculateSeatsPerRow(totalSeats, numRows, r_inner, r_outer) {
            let radii = Array.from({length: numRows}, (_, i) => r_outer - i * ((r_outer - r_inner) / (numRows - 1 || 1)));
            let proportionalSeats = radii.map(r => r * Math.PI);
            let totalProportional = proportionalSeats.reduce((sum, val) => sum + val, 0);
            let distributedSeats = 0;
            let seatDistribution = [];
            for (let i = 0; i < numRows; i++) {
                if (totalProportional === 0) { seatDistribution.push({ seats: 0, remainder: 0 }); continue; }
                let idealSeats = (proportionalSeats[i] / totalProportional) * totalSeats;
                let floorSeats = Math.floor(idealSeats);
                let remainder = idealSeats - floorSeats;
                seatDistribution.push({ seats: floorSeats, remainder: remainder, originalIndex: i });
                distributedSeats += floorSeats;
            }
            let diff = totalSeats - distributedSeats;
            seatDistribution.sort((a, b) => b.remainder - a.remainder);
            for (let i = 0; i < diff; i++) { if (seatDistribution[i]) seatDistribution[i].seats++; }
            seatDistribution.sort((a, b) => a.originalIndex - b.originalIndex);
            return seatDistribution.map(item => item.seats);
        }

        function togglePartySelection(partyName) {
            if (selectedParties.has(partyName)) selectedParties.delete(partyName);
            else selectedParties.add(partyName);
            document.querySelectorAll('.party-card').forEach(card => {
                const cardPartyName = card.querySelector('.party-card-name').textContent;
                if (selectedParties.has(cardPartyName)) card.classList.add('selected');
                else card.classList.remove('selected');
            });
            updateSummary();
        }

        function updateSummary() {
            const majorityThreshold = Math.floor(totalSeats / 2) + 1;
            
            // Filter to get only the selected parties
            const currentlySelected = currentSeatCounts.filter(sc => selectedParties.has(sc.party.name));

            // Calculate total seats from the filtered list
            const totalSelectedSeats = currentlySelected.reduce((sum, sc) => sum + sc.seats, 0);

            // Sort the filtered list by seats (descending) and map to get names
            const selectedPartyList = currentlySelected
                .sort((a, b) => b.seats - a.seats)
                .map(sc => sc.party.name);

            const summary = document.getElementById('summary');
            
            if (selectedParties.size === 0) {
                summary.className = "summary";
                summary.innerHTML = `
                    Parliament generated. Select parties to see if they form a majority.
                    <br><strong>Total seats allocated:</strong> ${currentSeatCounts.reduce((sum, sc) => sum + sc.seats, 0)}/${totalSeats}
                `;
            } else {
                if (totalSelectedSeats >= majorityThreshold) {
                    summary.className = "summary majority";
                    summary.innerHTML = `
                        <strong>MAJORITY COALITION (${totalSelectedSeats} seats)</strong><br>
                        Selected parties: ${selectedPartyList.join(", ")}<br>
                        These parties have enough seats to form a majority government.
                        <br><strong>Total selected seats:</strong> ${totalSelectedSeats}/${totalSeats} (need ${majorityThreshold}+)
                    `;
                } else {
                    summary.className = "summary no-majority";
                    summary.innerHTML = `
                        <strong>NO MAJORITY (${totalSelectedSeats} seats)</strong><br>
                        Selected parties: ${selectedPartyList.join(", ")}<br>
                        These parties do not have enough seats to form a majority.
                        <br><strong>Total selected seats:</strong> ${totalSelectedSeats}/${totalSeats} (need ${majorityThreshold}+)
                    `;
                }
            }
        }

        function showMarginModal() {
            marginControls.innerHTML = '';
            totalSeatsInput.value = totalSeats;
            
            parties.sort((a,b) => (a.ideologyScore || 0) - (b.ideologyScore || 0)).forEach((party, index) => {
                const originalIndex = parties.indexOf(party);
                const control = document.createElement('div');
                control.className = 'margin-control';
                control.innerHTML = `
                    <button class="remove-party-btn" data-index="${originalIndex}">Ã—</button>
                    <div style="font-weight: bold; margin-bottom: 5px;">
                        <input type="color" class="color-picker" value="${party.color}" data-index="${originalIndex}">
                        <input type="text" class="party-name-input" value="${party.name}" data-index="${originalIndex}">
                    </div>
                    <div>
                        Min: <input type="number" id="min-${originalIndex}" value="${party.minSeats}" min="0" max="${totalSeats - 1}">
                        Default: <input type="number" id="default-${originalIndex}" value="${party.defaultSeats}" min="0" max="${totalSeats}">
                        Max: <input type="number" id="max-${originalIndex}" value="${party.maxSeats}" min="1" max="${totalSeats}">
                        Ideology: <input type="number" id="ideology-${originalIndex}" value="${party.ideologyScore === undefined ? 0 : party.ideologyScore}" step="1">
                    </div>
                `;
                marginControls.appendChild(control);
            });
            
            // Add event listeners for remove buttons
            document.querySelectorAll('.remove-party-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    if (parties.length > 1) { // Ensure at least one party remains
                        parties.splice(index, 1);
                        showMarginModal(); // Refresh the modal
                    } else {
                        // Using a custom message box instead of alert
                        const modalContent = document.querySelector('.modal-content');
                        const msgBox = document.createElement('div');
                        msgBox.textContent = "You must have at least one party!";
                        msgBox.style.cssText = "padding: 10px; background-color: #f44336; color: white; margin-bottom: 10px; border-radius: 4px; text-align: center;";
                        modalContent.insertBefore(msgBox, marginControls);
                        setTimeout(() => msgBox.remove(), 3000);
                    }
                });
            });
            
            modal.style.display = 'block';
        }

        function addNewParty() {
            const name = newPartyName.value.trim();
            const color = newPartyColor.value;
            
            if (!name) {
                 const modalContent = document.querySelector('.modal-content');
                const msgBox = document.createElement('div');
                msgBox.textContent = "Please enter a party name.";
                msgBox.style.cssText = "padding: 10px; background-color: #f44336; color: white; margin-bottom: 10px; border-radius: 4px; text-align: center;";
                modalContent.insertBefore(msgBox, document.querySelector('.add-party-control'));
                setTimeout(() => msgBox.remove(), 3000);
                return;
            }
            
            // Calculate reasonable defaults based on current total seats
            const partyCount = parties.length + 1;
            const avgSeats = Math.floor(totalSeats / partyCount);
            
            parties.push({
                name: name,
                color: color,
                minSeats: Math.max(0, Math.floor(avgSeats * 0.3)),
                defaultSeats: Math.max(1, Math.floor(avgSeats * 0.7)),
                maxSeats: Math.max(2, Math.floor(avgSeats * 1.3)),
                ideologyScore: 0
            });
            
            // Clear the input
            newPartyName.value = '';
            
            // Refresh the modal
            showMarginModal();
        }

        function closeModal() {
            modal.style.display = 'none';
        }

        function saveMargins() {
            // Update total seats
            const newTotalSeats = parseInt(totalSeatsInput.value);
            if (newTotalSeats > 0) {
                totalSeats = newTotalSeats;
                totalSeatsDisplay.textContent = totalSeats;
            }

            parties.forEach((party, index) => {
                party.name = document.querySelector(`.party-name-input[data-index="${index}"]`).value;
                party.color = document.querySelector(`.color-picker[data-index="${index}"]`).value;
                party.minSeats = parseInt(document.getElementById(`min-${index}`).value);
                party.defaultSeats = parseInt(document.getElementById(`default-${index}`).value);
                party.maxSeats = parseInt(document.getElementById(`max-${index}`).value);
                party.ideologyScore = parseInt(document.getElementById(`ideology-${index}`).value) || 0;
                
                // Ensure min <= default <= max
                if (party.minSeats > party.defaultSeats) party.minSeats = party.defaultSeats;
                if (party.defaultSeats > party.maxSeats) party.defaultSeats = party.maxSeats;
                if (party.minSeats > party.maxSeats) party.minSeats = party.maxSeats;
                
                // Ensure max doesn't exceed total seats
                if (party.maxSeats > totalSeats) party.maxSeats = totalSeats;
                if (party.defaultSeats > totalSeats) party.defaultSeats = totalSeats;
                if (party.minSeats > totalSeats) party.minSeats = totalSeats;
            });
            
            closeModal();
            generateParliament(); 
        }

        function randomNormal(mean, stdDev) {
            let u = 0, v = 0;
            while (u === 0) u = Math.random();
            while (v === 0) v = Math.random();
            const normal = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            return mean + stdDev * normal;
        }
    </script>
</body>
</html>
